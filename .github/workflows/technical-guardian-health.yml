name: Technical Guardian - Health Monitor

on:
  schedule:
    # REDUCED: Changed from every 15 minutes to every 6 hours to reduce noise
    # Previous setting (*/15 * * * *) was creating 96 workflow runs per day
    - cron: '0 */6 * * *'  # Every 6 hours (4 times per day)
  workflow_dispatch:  # Allow manual triggering

permissions:
  issues: write
  contents: read

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Health (with retries)
        id: api_health
        run: |
          echo "Checking API health endpoint with retry logic..."
          
          # Retry logic: 3 attempts with 30-second waits
          # This handles Azure App Service cold starts gracefully
          MAX_ATTEMPTS=3
          ATTEMPT=1
          LAST_BODY=""
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -w "\n%{http_code}" --connect-timeout 30 --max-time 60 https://hrportal-backend-new.azurewebsites.net/api/health/ping || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            LAST_BODY="$BODY"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
              echo "response_body=$BODY" >> $GITHUB_OUTPUT
              echo "‚úÖ Health check passed on attempt $ATTEMPT"
              exit 0
            fi
            
            echo "Attempt $ATTEMPT failed with HTTP $HTTP_CODE"
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting 30 seconds before retry (may be cold start)..."
              sleep 30
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # Set outputs for failed state (for issue creation)
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_body=$LAST_BODY" >> $GITHUB_OUTPUT
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts with HTTP $HTTP_CODE"
          exit 1
      
      - name: Check Database Health (with retries)
        id: db_health
        if: success()
        run: |
          echo "Checking database health endpoint with retry logic..."
          
          MAX_ATTEMPTS=3
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -w "\n%{http_code}" --connect-timeout 30 --max-time 60 https://hrportal-backend-new.azurewebsites.net/api/health/db || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
              
              # Check if employee count is reasonable
              EMPLOYEE_COUNT=$(echo "$BODY" | jq -r '.employee_count // 0' 2>/dev/null || echo "0")
              echo "employee_count=$EMPLOYEE_COUNT" >> $GITHUB_OUTPUT
              echo "‚úÖ Database health check passed on attempt $ATTEMPT (Employees: $EMPLOYEE_COUNT)"
              exit 0
            fi
            
            echo "Attempt $ATTEMPT failed with HTTP $HTTP_CODE"
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting 30 seconds before retry..."
              sleep 30
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "‚ùå Database health check failed after $MAX_ATTEMPTS attempts with HTTP $HTTP_CODE"
          exit 1
      
      - name: Create Issue on Health Check Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const apiCode = '${{ steps.api_health.outputs.http_code }}';
            const dbCode = '${{ steps.db_health.outputs.http_code }}';
            
            let body = '## üö® Technical Guardian Alert: System Health Check Failed\n\n';
            body += '**Timestamp:** ' + new Date().toISOString() + '\n\n';
            body += '### Health Status\n\n';
            
            if (apiCode !== '200') {
              body += '- ‚ùå **API Health:** Failed (HTTP ' + apiCode + ')\n';
              body += '  - Endpoint: https://hrportal-backend-new.azurewebsites.net/api/health/ping\n\n';
            }
            
            if (dbCode !== '200' && dbCode !== '') {
              body += '- ‚ùå **Database Health:** Failed (HTTP ' + dbCode + ')\n';
              body += '  - Endpoint: https://hrportal-backend-new.azurewebsites.net/api/health/db\n\n';
            }
            
            body += '### Recommended Actions\n\n';
            body += '1. Check Azure App Service logs: `az webapp log tail --name hrportal-backend-new --resource-group baynunah-hr-portal-rg`\n';
            body += '2. Verify database connection string in App Service configuration\n';
            body += '3. Check if app service is running: `az webapp show --name hrportal-backend-new --resource-group baynunah-hr-portal-rg --query "state"`\n';
            body += '4. Review recent deployments for issues\n\n';
            body += '### References\n\n';
            body += '- [Azure System Engineer Assessment](../blob/main/AZURE_SYSTEM_ENGINEER_ASSESSMENT.md)\n';
            body += '- [Technical Guardian Guidelines](.github/agents/technical-guardian.md)\n\n';
            body += '---\n';
            body += '*This issue was automatically created by Technical Guardian Health Monitor*';
            
            // Check if there's already an open issue
            // Note: listForRepo uses comma-separated string for labels filter
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'technical-guardian,health-check',  // API expects comma-separated string
              per_page: 1
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              // Note: create API uses array for labels
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® System Health Check Failed',
                body: body,
                labels: ['technical-guardian', 'health-check', 'critical', 'automated']  // API expects array
              });
            } else {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: '### Health Check Failed Again\n\n' + body
              });
            }
      
      - name: Report Success
        if: success()
        run: |
          echo "‚úÖ Technical Guardian: All health checks passed"
          echo "API: https://hrportal-backend-new.azurewebsites.net/api/health/ping"
          echo "DB: https://hrportal-backend-new.azurewebsites.net/api/health/db"
          echo "Employees: ${{ steps.db_health.outputs.employee_count }}"
