name: Automated Maintenance

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

# SIMPLIFIED: This workflow was creating 4-5 separate issues per month.
# Now creates ONE consolidated maintenance summary issue.

jobs:
  monthly-maintenance:
    name: Monthly Maintenance Summary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check for npm vulnerabilities
        id: npm-audit
        working-directory: frontend
        continue-on-error: true
        run: |
          npm audit --json > audit.json 2>&1 || true
          # Validate JSON exists and is parseable before extracting values
          if [ -f audit.json ] && jq empty audit.json 2>/dev/null; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo "0")
          else
            CRITICAL="0"
            HIGH="0"
          fi
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
      
      - name: Find stale branches
        id: stale-branches
        run: |
          # Count branches older than 3 months (excluding main)
          # Match patterns like "3 months", "4 months", "5 months", or any "year"
          STALE_COUNT=$(git for-each-ref --format='%(refname:short) %(committerdate:relative)' refs/remotes/origin | grep -v "main\|HEAD" | grep -E '([3-9] months|[0-9]+ years|year ago)' | wc -l || echo "0")
          echo "stale_count=$STALE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Create consolidated maintenance issue
        uses: actions/github-script@v7
        with:
          script: |
            const critical = parseInt('${{ steps.npm-audit.outputs.critical }}') || 0;
            const high = parseInt('${{ steps.npm-audit.outputs.high }}') || 0;
            const staleBranches = parseInt('${{ steps.stale-branches.outputs.stale_count }}') || 0;
            
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
            
            let body = `## ðŸ”§ Monthly Maintenance Summary - ${today}\n\n`;
            body += `### Quick Status\n\n`;
            
            // Security status
            if (critical > 0 || high > 0) {
              body += `ðŸš¨ **Security Vulnerabilities Found**: ${critical} critical, ${high} high\n`;
              body += `   Run \`cd frontend && npm audit fix\` to fix\n\n`;
            } else {
              body += `âœ… **Security**: No critical/high vulnerabilities in npm dependencies\n\n`;
            }
            
            // Stale branches
            if (staleBranches > 0) {
              body += `ðŸ§¹ **Stale Branches**: ${staleBranches} branches are 3+ months old - consider cleanup\n\n`;
            } else {
              body += `âœ… **Branches**: No stale branches detected\n\n`;
            }
            
            body += `### Monthly Checklist\n\n`;
            body += `**For HR Admin (Solo Operator)**:\n\n`;
            body += `- [ ] Review and merge Dependabot PRs (if any)\n`;
            body += `- [ ] Test critical workflows (login, employee view, visa alerts)\n`;
            body += `- [ ] Review any error notifications from the past month\n`;
            body += `- [ ] Verify backups are working (if configured)\n\n`;
            
            body += `### Quick Health Check Commands\n\n`;
            body += `\`\`\`bash\n`;
            body += `# Check portal health\n`;
            body += `curl https://hrportal-backend-new.azurewebsites.net/api/health/ping\n\n`;
            body += `# Check database\n`;
            body += `curl https://hrportal-backend-new.azurewebsites.net/api/health/db\n\n`;
            body += `# Fix npm vulnerabilities (if any)\n`;
            body += `cd frontend && npm audit fix\n`;
            body += `\`\`\`\n\n`;
            
            body += `### UAE Compliance Monthly Verification\n\n`;
            body += `- [ ] Visa expiry alerts are being sent\n`;
            body += `- [ ] Emirates ID tracking is accurate\n`;
            body += `- [ ] Contract end dates display correctly\n\n`;
            
            body += `---\n`;
            body += `**Next maintenance**: ${nextMonth}\n\n`;
            body += `*Auto-generated by Monthly Maintenance workflow*`;
            
            // Check for existing open maintenance issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maintenance,monthly-summary',
              per_page: 1
            });
            
            if (existingIssues.data.length > 0) {
              // Update existing issue instead of creating a new one
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `### ${today} Monthly Update\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”§ Monthly Maintenance - ${today}`,
                body: body,
                labels: ['maintenance', 'monthly-summary']
              });
              console.log(`Created issue #${issue.data.number}`);
            }
