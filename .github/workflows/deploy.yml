name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-deploy:
    name: Build and Deploy HR Portal
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===== VALIDATE REQUIRED SECRETS =====
      - name: Validate required secrets
        run: |
          echo "üîç Validating required secrets..."
          
          if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "‚ùå ERROR: AZURE_CREDENTIALS secret is not set"
            echo "Please configure AZURE_CREDENTIALS in repository secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå ERROR: DATABASE_URL secret is not set"
            echo "Please configure DATABASE_URL in repository secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.AUTH_SECRET_KEY }}" ]; then
            echo "‚ùå ERROR: AUTH_SECRET_KEY secret is not set"
            echo "Please configure AUTH_SECRET_KEY in repository secrets"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are present"

      # ===== BUILD FRONTEND =====
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_BASE_URL: https://baynunahhrportal.azurewebsites.net/api

      # ===== PREPARE BACKEND =====
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify frontend build in backend/static
        run: |
          echo "üîç Verifying frontend build output..."
          if [ ! -d "backend/static" ]; then
            echo "‚ùå ERROR: backend/static directory does not exist"
            echo "Frontend build did not output to the expected location"
            exit 1
          fi
          
          if [ ! -f "backend/static/index.html" ]; then
            echo "‚ùå ERROR: backend/static/index.html not found"
            echo "Frontend build appears incomplete"
            exit 1
          fi
          
          echo "‚úÖ Frontend built successfully to backend/static"
          echo "Contents:"
          ls -lh backend/static/
          
          # Show bundle sizes
          if [ -d "backend/static/assets" ]; then
            echo "Asset files:"
            du -h backend/static/assets/* | sort -h
          fi

      - name: Create deployment package
        run: |
          echo "üì¶ Creating deployment package..."
          cd backend
          zip -r ../deploy.zip . \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*" \
            -x "*.env*" \
            -x "*.example" \
            -x "*.md" \
            -x "*test*.py" \
            -x "*.bak" \
            -x "*.tmp"
          cd ..
          echo "‚úÖ Package created: $(du -h deploy.zip | cut -f1)"
          
          # Verify static files are in the package
          echo "Verifying static files in package..."
          unzip -l deploy.zip | grep -q "static/index.html" && echo "‚úÖ index.html included" || echo "‚ö†Ô∏è  index.html not found in package"
          unzip -l deploy.zip | grep -q "static/assets" && echo "‚úÖ assets directory included" || echo "‚ö†Ô∏è  assets not found in package"

      # ===== DEPLOY TO AZURE =====
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: BaynunahHRPortal
          package: deploy.zip

      - name: Configure App Settings
        run: |
          echo "‚öôÔ∏è  Configuring Azure App Service settings..."
          az webapp config appsettings set \
            --name BaynunahHRPortal \
            --resource-group BaynunahHR \
            --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              AUTH_SECRET_KEY="${{ secrets.AUTH_SECRET_KEY }}" \
              ALLOWED_ORIGINS="https://baynunahhrportal.azurewebsites.net" \
              APP_ENV="production" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
            --output none
          echo "‚úÖ App settings configured successfully"

      # ===== POST-DEPLOYMENT MIGRATION =====
      - name: Run Alembic migrations
        continue-on-error: true
        run: |
          echo "üîÑ Attempting to run Alembic migrations..."
          echo ""
          echo "NOTE: This step runs migrations via Azure CLI. It may fail if:"
          echo "  - The app is still starting up"
          echo "  - Database connection requires different credentials"
          echo "  - Migrations require manual intervention"
          echo ""
          
          # Install uv for running alembic
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          
          # Try to run migrations via SSH (best effort)
          az webapp ssh --name BaynunahHRPortal --resource-group BaynunahHR --timeout 60 << 'EOF' || {
            echo "‚ö†Ô∏è  Could not run migrations via SSH"
            echo "This is expected for some Azure App Service configurations"
            echo ""
            echo "To run migrations manually:"
            echo "  1. SSH into the app: az webapp ssh --name BaynunahHRPortal --resource-group BaynunahHR"
            echo "  2. Navigate to app directory: cd /home/site/wwwroot"
            echo "  3. Run migrations: python -m alembic upgrade head"
            echo ""
            exit 0
          }
          
          cd /home/site/wwwroot
          python -m alembic upgrade head
          echo "‚úÖ Migrations completed successfully"
          EOF
          
          # Alternative: Try using Azure Web Jobs API (also best effort)
          if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è  SSH method failed, attempting via kudu API..."
            
            # Get publishing credentials
            KUDU_CREDS=$(az webapp deployment list-publishing-credentials \
              --name BaynunahHRPortal \
              --resource-group BaynunahHR \
              --query "{username:publishingUserName,password:publishingPassword}" \
              -o json 2>/dev/null) || {
              echo "‚ö†Ô∏è  Could not retrieve kudu credentials"
              echo "Skipping automatic migration - please run manually"
              exit 0
            }
            
            USERNAME=$(echo $KUDU_CREDS | jq -r .username)
            PASSWORD=$(echo $KUDU_CREDS | jq -r .password)
            
            # Run migration via kudu
            curl -X POST \
              "https://baynunahhrportal.scm.azurewebsites.net/api/command" \
              -u "$USERNAME:$PASSWORD" \
              -H "Content-Type: application/json" \
              -d '{"command": "cd /home/site/wwwroot && python -m alembic upgrade head", "dir": "/home/site/wwwroot"}' \
              --max-time 120 || {
              echo "‚ö†Ô∏è  Kudu API method also failed"
              echo ""
              echo "MANUAL MIGRATION REQUIRED:"
              echo "Run these commands after deployment:"
              echo "  az webapp ssh --name BaynunahHRPortal --resource-group BaynunahHR"
              echo "  cd /home/site/wwwroot"
              echo "  python -m alembic upgrade head"
              exit 0
            }
            
            echo "‚úÖ Migrations completed via kudu API"
          fi

      - name: Deployment Summary
        run: |
          echo ""
          echo "üéâ ================================================"
          echo "   DEPLOYMENT COMPLETE!"
          echo "================================================"
          echo ""
          echo "üì± App URL:      https://baynunahhrportal.azurewebsites.net"
          echo "üìö API Docs:     https://baynunahhrportal.azurewebsites.net/docs"
          echo "üîç Health Check: https://baynunahhrportal.azurewebsites.net/api/health"
          echo ""
          echo "‚úÖ Frontend assets deployed to backend/static"
          echo "‚úÖ App settings configured (DATABASE_URL, AUTH_SECRET_KEY)"
          echo "‚ö†Ô∏è  Check migration step above for any manual actions needed"
          echo ""
          echo "Next steps:"
          echo "  1. Verify the app is running: curl https://baynunahhrportal.azurewebsites.net/api/health"
          echo "  2. Check logs if needed: az webapp log tail --name BaynunahHRPortal --resource-group BaynunahHR"
          echo "  3. Test login at: https://baynunahhrportal.azurewebsites.net"
          echo ""
