name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy HR Portal
    runs-on: ubuntu-latest
    env:
      RESOURCE_GROUP: baynunah-hr-portal-rg
      WEBAPP_NAME: hrportal-backend-new
      WEBAPP_URL: https://hrportal-backend-new.azurewebsites.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "üîç Validating required secrets..."
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ] || \
             [ -z "${{ secrets.AZURE_TENANT_ID }}" ] || \
             [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "‚ùå ERROR: Azure OIDC secrets missing"
            exit 1
          fi
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå ERROR: DATABASE_URL secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AUTH_SECRET_KEY }}" ]; then
            echo "‚ùå ERROR: AUTH_SECRET_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets present"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install and build frontend
        working-directory: frontend
        run: |
          npm install
          npm run build
        env:
          VITE_API_BASE_URL: /api

      - name: Copy frontend build to backend/static
        run: |
          rm -rf backend/static
          cp -r frontend/dist backend/static
          echo "‚úÖ Frontend built to backend/static"
          ls -la backend/static/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create deployment package
        run: |
          cd backend
          chmod +x azure_startup.sh
          zip -r ../deploy.zip . \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*" \
            -x "*.env*" \
            -x "*test*.py" \
            -x "venv/*"
          cd ..
          echo "‚úÖ Package created: $(du -h deploy.zip)"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure App Settings
        run: |
          ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
          if [ -z "$ALLOWED_ORIGINS" ]; then
            ALLOWED_ORIGINS="$WEBAPP_URL"
          fi

          az webapp config appsettings set \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              AUTH_SECRET_KEY="${{ secrets.AUTH_SECRET_KEY }}" \
              ALLOWED_ORIGINS="$ALLOWED_ORIGINS" \
              APP_ENV="production" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
              ENABLE_ORYX_BUILD="false" \
            --output none

          az webapp config set \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --startup-file "bash azure_startup.sh" \
            --output none

          echo "‚úÖ App settings configured"

      - name: Deploy to Azure App Service
        run: |
          az webapp deploy \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --src-path deploy.zip \
            --type zip \
            --clean true \
            --restart true \
            --timeout 1200
          echo "‚úÖ Deployment completed"

      - name: Run database migrations
        run: |
          echo "üîÑ Running database migrations via Kudu..."

          # Get publishing credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name "$WEBAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)

          USERNAME=$(echo $CREDS | jq -r '.username')
          PASSWORD=$(echo $CREDS | jq -r '.password')

          # Run migration command via Kudu API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/json" \
            -d '{"command":"cd /home/site/wwwroot && source antenv/bin/activate 2>/dev/null || python3 -m venv antenv && source antenv/bin/activate && pip install -r requirements.txt -q && python -m alembic upgrade head 2>&1","dir":"/home/site/wwwroot"}' \
            "https://$WEBAPP_NAME.scm.azurewebsites.net/api/command")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Migration output:"
          echo "$BODY" | jq -r '.Output // .Error // .' 2>/dev/null || echo "$BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Migrations completed"
          else
            echo "‚ö†Ô∏è Migration command returned HTTP $HTTP_CODE (may still be OK)"
          fi

      - name: Restart App and Verify
        run: |
          az webapp restart --name "$WEBAPP_NAME" --resource-group "$RESOURCE_GROUP"
          echo "Waiting 60s for app to start..."
          sleep 60

          for i in 1 2 3; do
            HTTP_STATUS=$(curl -s -o /tmp/resp.txt -w "%{http_code}" "$WEBAPP_URL/api/health/ping")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Health check passed!"
              cat /tmp/resp.txt

              # Check DB health
              DB_STATUS=$(curl -s -o /tmp/db.txt -w "%{http_code}" "$WEBAPP_URL/api/health/db")
              echo ""
              echo "Database health (HTTP $DB_STATUS):"
              cat /tmp/db.txt | head -20
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_STATUS, retrying in 30s..."
            sleep 30
          done

          echo "‚ö†Ô∏è Health check did not pass - check logs"
          exit 0

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "üéâ DEPLOYMENT COMPLETE"
          echo "====================="
          echo "App URL: $WEBAPP_URL"
          echo "API Docs: $WEBAPP_URL/docs"
          echo ""
          echo "If login issues persist, reset admin:"
          echo "curl -X POST $WEBAPP_URL/api/health/reset-admin-password -H 'X-Admin-Secret: YOUR_AUTH_SECRET_KEY'"
          echo ""
          echo "Admin login: BAYN00008 / 16051988"

# Trigger deployment Tue Jan 20 08:46:00 AM UTC 2026

