name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

permissions:
  id-token: write # Required for OIDC authentication with Azure
  contents: read # Required to checkout code

jobs:
  build-and-deploy:
    name: Build and Deploy HR Portal
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===== VALIDATE REQUIRED SECRETS =====
      - name: Validate required secrets
        run: |
          echo "üîç Validating required secrets..."

          # Validate Azure OIDC secrets (no client-secret needed)
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ] || \
             [ -z "${{ secrets.AZURE_TENANT_ID }}" ] || \
             [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "‚ùå ERROR: One or more Azure OIDC authentication secrets are missing"
            echo "Required secrets: AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID"
            exit 1
          fi

          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå ERROR: DATABASE_URL secret is not set"
            echo "Please configure DATABASE_URL in repository secrets"
            exit 1
          fi

          if [ -z "${{ secrets.AUTH_SECRET_KEY }}" ]; then
            echo "‚ùå ERROR: AUTH_SECRET_KEY secret is not set"
            echo "Please configure AUTH_SECRET_KEY in repository secrets"
            exit 1
          fi

          if [ -z "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "‚ö†Ô∏è  ALLOWED_ORIGINS secret is not set; defaulting to Azure web app URL"
          fi

          echo "‚úÖ All required secrets are present"

      # ===== BUILD FRONTEND =====
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_BASE_URL: /api

      # ===== PREPARE BACKEND =====
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify frontend build in backend/static
        run: |
          echo "üîç Verifying frontend build output..."
          if [ ! -d "backend/static" ]; then
            echo "‚ùå ERROR: backend/static directory does not exist"
            echo "Frontend build did not output to the expected location"
            exit 1
          fi

          if [ ! -f "backend/static/index.html" ]; then
            echo "‚ùå ERROR: backend/static/index.html not found"
            echo "Frontend build appears incomplete"
            exit 1
          fi

          # Verify JS bundles exist (critical for frontend to work)
          if [ ! -d "backend/static/assets" ] || [ -z "$(ls -A backend/static/assets/*.js 2>/dev/null)" ]; then
            echo "‚ùå ERROR: No JavaScript bundles found in backend/static/assets/"
            echo "Frontend build failed to generate JS files"
            exit 1
          fi

          echo "‚úÖ Frontend built successfully to backend/static"
          echo "Contents:"
          ls -lh backend/static/

          # Show bundle sizes
          if [ -d "backend/static/assets" ]; then
            echo "Asset files:"
            du -h backend/static/assets/* | sort -h
          fi

      - name: Create deployment package
        run: |
          echo "üì¶ Creating deployment package..."
          cd backend

          # Ensure azure_startup.sh is executable
          chmod +x azure_startup.sh

          zip -r ../deploy.zip . \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*" \
            -x "*.env*" \
            -x "*.example" \
            -x "*.md" \
            -x "*test*.py" \
            -x "*.bak" \
            -x "*.tmp"
          cd ..
          echo "‚úÖ Package created: $(du -h deploy.zip | cut -f1)"

          # Verify static files are in the package
          echo "Verifying static files in package..."
          if ! unzip -l deploy.zip | grep -q "static/index.html"; then
            echo "‚ùå ERROR: static/index.html not found in package"
            exit 1
          else
            echo "‚úÖ index.html included"
          fi

          # Verify azure_startup.sh is included
          if ! unzip -l deploy.zip | grep -q "azure_startup.sh"; then
            echo "‚ùå ERROR: azure_startup.sh not found in package"
            exit 1
          else
            echo "‚úÖ azure_startup.sh included"
          fi

      # ===== DEPLOY TO AZURE =====
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Azure Resources Exist
        run: |
          echo "üîç Checking if Azure resources exist..."

          # Check if resource group exists
          if ! az group show --name baynunah-hr-rg --query name -o tsv 2>/dev/null; then
            echo "üì¶ Creating resource group baynunah-hr-rg..."
            az group create --name baynunah-hr-rg --location westeurope
          else
            echo "‚úÖ Resource group baynunah-hr-rg exists"
          fi

          # Check if App Service plan exists
          if ! az appservice plan show --name baynunah-hr-plan --resource-group baynunah-hr-rg --query name -o tsv 2>/dev/null; then
            echo "üì¶ Creating App Service plan baynunah-hr-plan..."
            az appservice plan create \
              --name baynunah-hr-plan \
              --resource-group baynunah-hr-rg \
              --sku B1 \
              --is-linux
          else
            echo "‚úÖ App Service plan baynunah-hr-plan exists"
          fi

          # Check if Web App exists
          if ! az webapp show --name baynunah-hr-portal --resource-group baynunah-hr-rg --query name -o tsv 2>/dev/null; then
            echo "üì¶ Creating Web App baynunah-hr-portal..."
            az webapp create \
              --name baynunah-hr-portal \
              --resource-group baynunah-hr-rg \
              --plan baynunah-hr-plan \
              --runtime "PYTHON:3.11"
          else
            echo "‚úÖ Web App baynunah-hr-portal exists"
          fi

          echo "‚úÖ All Azure resources verified/created"

      - name: Configure App Settings
        run: |
          echo "‚öôÔ∏è  Configuring Azure App Service settings..."
          ALLOWED_ORIGINS_VALUE="${{ secrets.ALLOWED_ORIGINS }}"
          if [ -z "$ALLOWED_ORIGINS_VALUE" ]; then
            ALLOWED_ORIGINS_VALUE="https://baynunah-hr-portal.azurewebsites.net"
          fi

          az webapp config appsettings set \
            --name baynunah-hr-portal \
            --resource-group baynunah-hr-rg \
            --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              AUTH_SECRET_KEY="${{ secrets.AUTH_SECRET_KEY }}" \
              ALLOWED_ORIGINS="$ALLOWED_ORIGINS_VALUE" \
              APP_ENV="production" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
              ENABLE_ORYX_BUILD="false" \
              PYTHONUNBUFFERED="1" \
              WEBSITES_CONTAINER_START_TIME_LIMIT="1800" \
            --output none

          # Set startup command
          az webapp config set \
            --name baynunah-hr-portal \
            --resource-group baynunah-hr-rg \
            --startup-file "bash azure_startup.sh" \
            --output none

          # Configure health check path (uses unauthenticated /api/health/ping)
          az webapp config set \
            --name baynunah-hr-portal \
            --resource-group baynunah-hr-rg \
            --generic-configurations '{"healthCheckPath": "/api/health/ping"}' \
            --output none

          echo "‚úÖ App settings configured successfully"

      - name: Deploy to Azure App Service
        run: |
          echo "üöÄ Deploying to Azure App Service..."

          # Use az webapp deploy which respects no-build settings
          # First, ensure build is disabled at the SCM level
          az webapp config appsettings set \
            --name baynunah-hr-portal \
            --resource-group baynunah-hr-rg \
            --settings \
              WEBSITE_RUN_FROM_PACKAGE="0" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
              ENABLE_ORYX_BUILD="false" \
            --output none

          # Deploy using the newer az webapp deploy command with --type zip
          az webapp deploy \
            --name baynunah-hr-portal \
            --resource-group baynunah-hr-rg \
            --src-path deploy.zip \
            --type zip \
            --clean true \
            --restart true \
            --timeout 1200

          echo "‚úÖ Deployment completed"

      - name: Restart App Service
        run: |
          echo "üîÑ Restarting App Service to apply changes..."
          az webapp restart \
            --name baynunah-hr-portal \
            --resource-group baynunah-hr-rg
          echo "‚úÖ App Service restarted"

      - name: Verify deployment health
        run: |
          echo "üîç Checking deployment health..."
          echo "Waiting 60 seconds for app to start..."
          sleep 60

          # Try up to 6 times with increasing delays
          for i in 1 2 3 4 5 6; do
            echo "Attempt $i: Checking health ping (no auth)..."
            HTTP_STATUS=$(curl -s -o /tmp/health_response.txt -w "%{http_code}" https://baynunah-hr-portal.azurewebsites.net/api/health/ping 2>/dev/null || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Health ping passed (HTTP $HTTP_STATUS)"
              cat /tmp/health_response.txt
              echo ""
              
              # Also check DB health (optional, informational)
              echo "Checking database health..."
              DB_STATUS=$(curl -s -o /tmp/db_response.txt -w "%{http_code}" https://baynunah-hr-portal.azurewebsites.net/api/health/db 2>/dev/null || echo "000")
              echo "Database health: HTTP $DB_STATUS"
              cat /tmp/db_response.txt 2>/dev/null | head -10 || echo "(no response)"
              exit 0
            else
              echo "‚è≥ HTTP $HTTP_STATUS - Response:"
              cat /tmp/health_response.txt 2>/dev/null | head -5 || echo "(no response)"
              echo ""
              
              if [ $i -lt 6 ]; then
                echo "Waiting $((i * 20)) seconds before retry..."
                sleep $((i * 20))
              fi
            fi
          done

          echo "‚ö†Ô∏è  Health check did not return 200 after 6 attempts"
          echo "The app may still be starting or there may be an issue."
          echo ""
          echo "Check logs with:"
          echo "  az webapp log tail --name baynunah-hr-portal --resource-group baynunah-hr-rg"
          echo ""
          echo "Check app at: https://baynunah-hr-portal.azurewebsites.net"
          # Don't fail the workflow - let it complete so we can check logs
          exit 0

      - name: Deployment Summary
        run: |
          echo ""
          echo "üéâ ================================================"
          echo "   DEPLOYMENT COMPLETE!"
          echo "================================================"
          echo ""
          echo "üì± App URL:      https://baynunah-hr-portal.azurewebsites.net"
          echo "üìö API Docs:     https://baynunah-hr-portal.azurewebsites.net/docs"
          echo "üîç Health Check: https://baynunah-hr-portal.azurewebsites.net/api/health"
          echo "üîç DB Health:    https://baynunah-hr-portal.azurewebsites.net/api/health/db"
          echo ""
          echo "‚úÖ Frontend assets deployed to backend/static"
          echo "‚úÖ App settings configured (DATABASE_URL, AUTH_SECRET_KEY)"
          echo "‚úÖ Startup script: azure_startup.sh (installs deps & runs migrations)"
          echo ""
          echo "If login issues occur, reset admin password:"
          echo "  curl -X POST https://baynunah-hr-portal.azurewebsites.net/api/health/reset-admin-password \\"
          echo "    -H 'X-Admin-Secret: YOUR_AUTH_SECRET_KEY'"
          echo ""
          echo "Default admin credentials after reset:"
          echo "  Employee ID: BAYN00008"
          echo "  Password: 16051988"
          echo ""
